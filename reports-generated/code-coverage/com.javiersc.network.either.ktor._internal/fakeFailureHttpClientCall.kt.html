<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>fakeFailureHttpClientCall.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.network.either.ktor._internal</a> &gt; <span class="el_source">fakeFailureHttpClientCall.kt</span></div><h1>fakeFailureHttpClientCall.kt</h1><pre class="source lang-java linenums">package com.javiersc.network.either.ktor._internal

import io.ktor.client.HttpClient
import io.ktor.client.call.HttpClientCall
import io.ktor.client.request.DefaultHttpRequest
import io.ktor.client.request.HttpRequestBuilder
import io.ktor.client.request.HttpRequestData
import io.ktor.client.request.HttpResponseData
import io.ktor.client.request.setBody
import io.ktor.client.statement.DefaultHttpResponse
import io.ktor.http.HttpProtocolVersion
import io.ktor.http.content.OutgoingContent
import io.ktor.util.AttributeKey
import io.ktor.util.date.GMTDate
import io.ktor.util.pipeline.PipelineContext
import io.ktor.util.toMap
import io.ktor.utils.io.ByteReadChannel

internal fun PipelineContext&lt;Any, HttpRequestBuilder&gt;.fakeHttpFailureClientCall(
    client: HttpClient
): HttpClientCall {
<span class="fc" id="L22">    val responseData: HttpResponseData = failureHttpResponseData(RemoteErrorOutgoing)</span>
<span class="fc" id="L23">    val call: HttpClientCall =</span>
<span class="fc" id="L24">        object : HttpClientCall(client) {</span>
<span class="nc" id="L25">            val httpRequestData: HttpRequestData =</span>
<span class="fc" id="L26">                HttpRequestBuilder()</span>
<span class="fc" id="L27">                    .apply {</span>
<span class="fc" id="L28">                        setBody(RemoteErrorOutgoing)</span>
<span class="fc" id="L29">                        attributes.put(AttributeKey(&quot;ExpectSuccessAttributeKey&quot;), false)</span>
<span class="fc" id="L30">                    }</span>
<span class="fc" id="L31">                    .build()</span>
<span class="fc" id="L32">            init {</span>
<span class="fc" id="L33">                request = DefaultHttpRequest(this, httpRequestData)</span>
<span class="fc" id="L34">                response = DefaultHttpResponse(this, responseData)</span>
<span class="fc" id="L35">            }</span>
        }

<span class="fc" id="L38">    return call</span>
}

internal fun PipelineContext&lt;Any, HttpRequestBuilder&gt;.fakeLocalFailureClientCall(
    client: HttpClient
): HttpClientCall {
<span class="fc" id="L44">    val responseData: HttpResponseData = failureHttpResponseData(LocalErrorOutgoing)</span>
<span class="fc" id="L45">    val call: HttpClientCall =</span>
<span class="fc" id="L46">        object : HttpClientCall(client) {</span>
<span class="nc" id="L47">            val httpRequestData: HttpRequestData =</span>
<span class="fc" id="L48">                HttpRequestBuilder()</span>
<span class="fc" id="L49">                    .apply {</span>
<span class="fc" id="L50">                        setBody(LocalErrorOutgoing)</span>
<span class="fc" id="L51">                        attributes.put(AttributeKey(&quot;ExpectSuccessAttributeKey&quot;), false)</span>
<span class="fc" id="L52">                    }</span>
<span class="fc" id="L53">                    .build()</span>
<span class="fc" id="L54">            init {</span>
<span class="fc" id="L55">                request = DefaultHttpRequest(this, httpRequestData)</span>
<span class="fc" id="L56">                response = DefaultHttpResponse(this, responseData)</span>
<span class="fc" id="L57">            }</span>
        }

<span class="fc" id="L60">    return call</span>
}

internal fun PipelineContext&lt;Any, HttpRequestBuilder&gt;.failureHttpResponseData(
    outgoingContent: OutgoingContent
): HttpResponseData {
<span class="fc" id="L66">    val status = outgoingContent.status</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">    checkNotNull(status) { &quot;Status must not be null and this should not be happening&quot; }</span>
<span class="fc" id="L68">    val headers = outgoingContent.headers</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">    check(headers.toMap().keys.contains(&quot;NetworkEither&quot;)) {</span>
<span class="nc" id="L70">        &quot;Headers must contain `NetworkEither` key and this should not be happening&quot;</span>
    }
<span class="fc" id="L72">    return HttpResponseData(</span>
<span class="fc" id="L73">        statusCode = status,</span>
<span class="fc" id="L74">        requestTime = GMTDate(),</span>
<span class="fc" id="L75">        headers = outgoingContent.headers,</span>
<span class="fc" id="L76">        version = HttpProtocolVersion.HTTP_1_1,</span>
<span class="fc" id="L77">        body = ByteReadChannel(&quot;&quot;.toByteArray(Charsets.UTF_8)),</span>
<span class="fc" id="L78">        callContext = context.executionContext,</span>
    )
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>